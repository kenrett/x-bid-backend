name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      RAILS_ENV: test
      PGHOST: localhost
      PGUSER: postgres
      PGPASSWORD: postgres
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/x_bid_backend_test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - name: Prepare database
        run: bundle exec rails db:prepare

      - name: Run tests
        run: bundle exec rails test

  scan_ruby:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - name: Check gems for known vulnerabilities
        run: bundle exec bundler-audit check --update

      - name: Scan for common Rails security vulnerabilities using static analysis
        run: bin/brakeman --no-pager

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - name: Lint code for consistent style
        run: bin/rubocop -f github

  openapi_drift:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      RAILS_ENV: test
      PGHOST: localhost
      PGUSER: postgres
      PGPASSWORD: postgres
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/x_bid_backend_test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - name: Prepare database
        run: bundle exec rails db:prepare

      - name: Generate OpenAPI spec (deterministic)
        run: |
          set -euo pipefail
          bundle exec rails openapi:generate
          cp docs/api/openapi.json /tmp/openapi.json
          bundle exec rails openapi:generate
          diff -u /tmp/openapi.json docs/api/openapi.json
          cp docs/api/openapi.json openapi.json
          test -f openapi.json

      - name: Emit OpenAPI artifact metadata
        id: openapi_meta
        run: |
          set -euo pipefail
          echo "artifact_name=openapi-json" >> "$GITHUB_OUTPUT"
          echo "spec_path=$(realpath openapi.json)" >> "$GITHUB_OUTPUT"
          echo "run_id=${GITHUB_RUN_ID}" >> "$GITHUB_OUTPUT"
          echo "OpenAPI artifact: openapi-json"
          echo "OpenAPI spec path: $(realpath openapi.json)"
          echo "GitHub run id: ${GITHUB_RUN_ID}"

      - name: Upload OpenAPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-json
          path: |
            openapi.json
            docs/api/openapi.json
          if-no-files-found: error
          retention-days: 14

      - name: Fail on schema drift
        run: git diff --stat --exit-code docs/api/openapi.json

    outputs:
      artifact_name: ${{ steps.openapi_meta.outputs.artifact_name }}
      spec_path: ${{ steps.openapi_meta.outputs.spec_path }}
      run_id: ${{ steps.openapi_meta.outputs.run_id }}

  frontend_contract:
    name: Frontend contract (CT-2)
    runs-on: ubuntu-latest
    needs: openapi_drift
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout backend (for diff detection)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download OpenAPI artifact
        uses: actions/download-artifact@v7
        with:
          name: ${{ needs.openapi_drift.outputs.artifact_name }}
          path: openapi-artifact

      - name: Locate OpenAPI artifact path
        id: openapi_path
        run: |
          set -euo pipefail
          found="$(find openapi-artifact -type f -name openapi.json -print -quit)"
          if [[ -z "${found}" ]]; then
            echo "::error::Unable to locate openapi.json in downloaded artifact; this workflow downloads the backend OpenAPI artifact and sets OPENAPI_SPEC_PATH for frontend scripts."
            find openapi-artifact -maxdepth 4 -type f -print || true
            exit 1
          fi
          echo "path=$(realpath "$found")" >> "$GITHUB_OUTPUT"

      - name: Export OPENAPI_SPEC_PATH for frontend steps
        run: |
          set -euo pipefail
          echo "OPENAPI_SPEC_PATH=${{ steps.openapi_path.outputs.path }}" >> "$GITHUB_ENV"

      - name: Validate frontend CI configuration
        run: |
          set -euo pipefail
          if [[ -z "${{ vars.FRONTEND_REPO || '' }}" ]]; then
            echo "::error::Missing required repo variable FRONTEND_REPO (e.g. owner/x-bid-frontend)."
            exit 1
          fi

      - name: Checkout frontend repo
        uses: actions/checkout@v4
        with:
          repository: ${{ vars.FRONTEND_REPO }}
          ref: ${{ vars.FRONTEND_REF || 'main' }}
          path: frontend
          # For private repos, set a PAT with read access as secret FRONTEND_CI_TOKEN.
          token: ${{ secrets.FRONTEND_CI_TOKEN || github.token }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ vars.FRONTEND_NODE_VERSION || '20' }}

      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          set -euo pipefail
          if [[ -f package-lock.json ]]; then
            npm ci
            echo "FRONTEND_PKG_MANAGER=npm" >> "$GITHUB_ENV"
          elif [[ -f pnpm-lock.yaml ]]; then
            corepack enable
            pnpm -v
            pnpm install --frozen-lockfile
            echo "FRONTEND_PKG_MANAGER=pnpm" >> "$GITHUB_ENV"
          elif [[ -f yarn.lock ]]; then
            corepack enable
            yarn -v
            yarn install --frozen-lockfile
            echo "FRONTEND_PKG_MANAGER=yarn" >> "$GITHUB_ENV"
          else
            npm install
            echo "FRONTEND_PKG_MANAGER=npm" >> "$GITHUB_ENV"
          fi

      - name: Run frontend OpenAPI type checks (check:api-types)
        working-directory: frontend
        run: |
          set -euo pipefail
          if [[ -z "${OPENAPI_SPEC_PATH:-}" ]]; then
            echo "::error::OPENAPI_SPEC_PATH is not set; it should be populated from the downloaded OpenAPI artifact."
            exit 1
          fi

          if [[ "$OPENAPI_SPEC_PATH" =~ ^https?:// ]]; then
            echo "::error::OPENAPI_SPEC_PATH must be a local file path (not a URL)."
            exit 1
          fi

          if [[ ! -f "$OPENAPI_SPEC_PATH" ]]; then
            echo "::error::Missing OpenAPI artifact at $OPENAPI_SPEC_PATH (downloaded artifact -> OPENAPI_SPEC_PATH)."
            exit 1
          fi

          if [[ ! -f package.json ]]; then
            echo "::error::No package.json found in frontend repo; cannot run check:api-types."
            exit 1
          fi

          if ! node -e 'p=require("./package.json"); s=(p.scripts||{}); process.exit(s["check:api-types"]?0:1)'; then
            echo "::error::Missing required frontend script check:api-types. It should read OPENAPI_SPEC_PATH and fail if types drift."
            exit 1
          fi

          case "${FRONTEND_PKG_MANAGER:-npm}" in
            pnpm) pnpm run check:api-types ;;
            yarn) yarn run check:api-types ;;
            *) npm run check:api-types ;;
          esac

      - name: Run frontend contract drift tests (CT-2)
        working-directory: frontend
        run: |
          set -euo pipefail
          if [[ -z "${OPENAPI_SPEC_PATH:-}" ]]; then
            echo "::error::OPENAPI_SPEC_PATH is not set; it should be populated from the downloaded OpenAPI artifact."
            exit 1
          fi

          if [[ "$OPENAPI_SPEC_PATH" =~ ^https?:// ]]; then
            echo "::error::OPENAPI_SPEC_PATH must be a local file path (not a URL)."
            exit 1
          fi

          if [[ ! -f "$OPENAPI_SPEC_PATH" ]]; then
            echo "::error::Missing OpenAPI artifact at $OPENAPI_SPEC_PATH (downloaded artifact -> OPENAPI_SPEC_PATH)."
            exit 1
          fi

          if [[ ! -f package.json ]]; then
            echo "::error::No package.json found in frontend repo; cannot run ct-2."
            exit 1
          fi

          if ! node -e 'p=require("./package.json"); s=(p.scripts||{}); process.exit(s["ct-2"]?0:1)'; then
            echo "::error::No ct-2 script found in frontend package.json (expected ct-2)."
            exit 1
          fi

          case "${FRONTEND_PKG_MANAGER:-npm}" in
            pnpm) pnpm run ct-2 ;;
            yarn) yarn run ct-2 ;;
            *) npm run ct-2 ;;
          esac

      - name: Fail if frontend repo has uncommitted changes
        working-directory: frontend
        run: |
          set -euo pipefail
          git status --porcelain
          git diff --exit-code
