#!/bin/bash
set -e

echo "üîê Verifying Kamal secrets configuration..."

# Run kamal envify to generate the secrets output (without printing it to logs)
# and search for the required keys.
SECRETS_OUTPUT=$(bin/kamal envify)

MISSING=0

for SECRET in "DATABASE_URL" "RAILS_MASTER_KEY" "KAMAL_REGISTRY_PASSWORD"; do
  if echo "$SECRETS_OUTPUT" | grep -q "^$SECRET="; then
    echo "‚úÖ $SECRET is set."
  else
    echo "‚ùå $SECRET is MISSING."
    MISSING=1
  fi
done

if [ $MISSING -eq 1 ]; then
  echo ""
  echo "‚ö†Ô∏è  Some secrets are missing. Check .kamal/secrets and your environment variables."
  exit 1
else
  echo ""
  echo "üéâ All secrets verified. Ready to deploy."
  exit 0
fi