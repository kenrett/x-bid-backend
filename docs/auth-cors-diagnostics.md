# Auth + CORS Diagnostics

This guide describes how to confirm auth inputs, CORS behavior, and where 502s are generated.

## Canary checks

Run these from a machine that can reach production:

```bash
curl -i https://API_HOST/api/v1/health
curl -i -X OPTIONS https://API_HOST/api/v1/login \
  -H "Origin: https://WWW_HOST" \
  -H "Access-Control-Request-Method: POST" \
  -H "Access-Control-Request-Headers: content-type"
curl -i -X POST https://API_HOST/api/v1/login \
  -H "Origin: https://WWW_HOST" \
  -H "Content-Type: application/json" \
  -d '{"email_address":"x","password":"y"}'
```

The response headers should include `X-Request-Id`. Use that value to correlate logs.

## What to look for in logs

Use request_id to find the structured JSON log line. Example:

```bash
rg '"event":"http.request".*"request_id":"REQUEST_ID"' log/production.log
```

Common log events:

- `http.request` includes request metadata, auth header/cookie presence, and CORS details.
- `auth.invalid_token.missing_credentials` shows why the invalid_token response was returned.
- `action_cable.connect.diagnostics` shows cookies/params/env keys available on WebSocket connect.
- `cors.config` logs the allowed origins, headers, and methods at boot (prod/staging).

## How to interpret outcomes

### A) invalid_token after storefront switch

Look for `auth.invalid_token.missing_credentials` with the same `request_id`:

```bash
rg '"event":"auth.invalid_token.missing_credentials".*"request_id":"REQUEST_ID"' log/production.log
```

Check:
- `authorization_present` and `authorization_redacted`
- `cookie_present` and `cookie_names`

If `authorization_present=false` and `cookie_present=false`, the backend is not receiving either input.

### B) production login "502 CORS"

Check whether Rails saw the request:

- If `curl` returns 502 and there is no `http.request` log line for that request_id, the 502 is likely generated by a proxy/load balancer.
- If `http.request` exists with status 502, Rails handled it; check any `error_class` in the log line and Rails exceptions.

### C) OPTIONS preflight visibility

Find the OPTIONS request log:

```bash
rg '"event":"http.request".*"method":"OPTIONS".*"path":"/api/v1/login"' log/production.log
```

Confirm:
- `options_requested_method` and `options_requested_headers`
- `cors_response_headers` includes `allow_origin`, `allow_credentials`, `allow_headers`, `allow_methods`

If the OPTIONS request never appears, the preflight likely did not reach Rails.

### D) ActionCable auth inputs

Check the ActionCable diagnostic line:

```bash
rg '"event":"action_cable.connect.diagnostics"' log/production.log
```

Confirm:
- `cookie_present` and `cookie_names`
- `param_keys`
- `token_present` and `token_redacted`
- `origin` and `path`

This shows what was available to the ActionCable connection without exposing sensitive values.
